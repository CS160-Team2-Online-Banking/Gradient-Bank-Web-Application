{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/accounts.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/signup.css' %}">

{% endblock %}


{% block contents %}

<div>
    <h1> ATM Locator</h1>
    <p>Look for an ATM nearest to you with the map below</p>
</div>

<div id="map"></div>
<div id="dir_box"></div>
<!-- Replace the value of the key parameter with your own API key. -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAqLzAMqgeVjFb9sf1LLL2heFhLjy8NEYY&callback=initMap&libraries=places">
    </script>

<script>
    var map, infoWindow, service, directionsServ, directionsRend, userMarker, atmLocations, userPos;
    
    function initMap(listener) {
        directionsServ = new google.maps.DirectionsService();
        directionsRend = new google.maps.DirectionsRenderer();
        map = new google.maps.Map(document.getElementById('map'), {
            center: {
                lat: 37.335,
                lng: -121.893
            },
            zoom: 14
        });
        google.maps.event.trigger(map, 'resize');
        infoWindow = new google.maps.InfoWindow;
        directionsRend.setMap(map); // tell the direction renderer to draw on our map
        
        const locationButton = document.createElement("button");
        locationButton.textContent = "Current Location";
        locationButton.classList.add("custom-map-control-button");
        map.controls[google.maps.ControlPosition.TOP_CENTER].push(locationButton);
        locationButton.addEventListener("click", () => {
            // Try HTML5 geolocation.
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    userPos = pos;


                    map.setCenter(pos);
                    //Put marker of the Geolocated user location
                    userMarker = new google.maps.Marker({
                        map: map,
                        position: pos
                    });

                    google.maps.event.addListener(userMarker, 'click', function () {
                        infoWindow.setContent('Your location');
                        infoWindow.open(map, this);
                    });

                    //Put request in here there are 3 requests since nearbysearch only has one type to be specified

                    var requestAtm = {
                        location: pos,
                        radius: '8000',
                        name: "Chase ATM",
                        //type: ['atm']
                    };


                    //Make Places Service requests here
                    service = new google.maps.places.PlacesService(map);
                    //service.nearbySearch(requestHosp, callback);
                    service.nearbySearch(requestAtm, callback);
                    //service.nearbySearch(requestPolice, callback);

                }, function () {
                    handleLocationError(true, infoWindow, map.getCenter());
                });
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, infoWindow, map.getCenter());
            }
        });
    }

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
            'Error: The Geolocation service failed.' :
            'Error: Your browser doesn\'t support geolocation.');
        infoWindow.open(map);
    }

    function getRouteCost(directionResponse) {
        let route_cost = 0;
        to_route = directionResponse.routes[0];
        for (const leg of to_route.legs) {
            route_cost = route_cost + leg.duration.value;
        }
        return route_cost;
    }

    function getClosestATM(places, callback) {
        /*
            I've yet to find a convenient API method for this: we should use an API method if one exists
            instead because right now we're making multiple queries to the API.

            Anyway, the way this method works is that it searches each place starting from the location
            with the closest distance as the crow flies (straight line) and determines which one has the
            shortest "cost" (trip duration) associated with it. It exits either when a route is found
            with a cost that is greater than the previous place or when it exhausts all places.
        */
        var fastest_route = null;
        var closest_atm;
        var places_stack = places.reverse();
        var place = places_stack.pop();
        function next(response, status) {
            if (status === "OK") {
                directionsRend.setDirections(response);
                if (fastest_route == null || getRouteCost(fastest_route) > getRouteCost(response)) {
                    fastest_route = response;
                    closest_atm = place;

                    place = places_stack.pop()
                    if (places_stack.length > 1) {
                        directionsServ.route({
                            origin: userPos,
                            destination: { placeId: place.place_id },
                            travelMode: google.maps.TravelMode.DRIVING,
                        }, next);
                    } else {
                        callback(fastest_route, closest_atm);
                    }
                    return;
                }
                callback(fastest_route, closest_atm);
            }
        }
        directionsServ.route({
            origin: userPos,
            destination: { placeId: place.place_id },
            travelMode: google.maps.TravelMode.DRIVING,
        }, next);
    }

    function callback(results, status) {
        if (status == google.maps.places.PlacesServiceStatus.OK) {
            atmLocations = results;
            for (var i = 0; i < results.length; i++) {
                var place = results[i];
                createMarker(results[i]);
            }

            getClosestATM(results, (fastest_route, closest_atm) => {
                console.log("CLOSEST LOCATION FOUND");
                directionsRend.setDirections(fastest_route);
                directionsRend.setPanel(document.getElementById('dir_box'));
            });

        }
    }


    function createMarker(place) {
        var type = place.types;
        var iconStyle;
        for (var i = 0; i < type.length; i++) {
            //put array of Place types in placeType variable
            var placeType = type[i];

            //Check the placeType and set the icon according to the placeType value
            switch (placeType) {
                case "bank":
                case "atm":
                    iconStyle = "http://maps.google.com/mapfiles/kml/shapes/dollar.png";
                    break;

            }
        }

        //put marker of the places in the map
        var marker = new google.maps.Marker({
            map: map,
            icon: iconStyle,
            position: place.geometry.location
        });

        google.maps.event.addListener(marker, 'click', function () {
            infoWindow.setContent(place.name);
            console.log(place);
            infoWindow.open(map, this);

            directionsServ.route({
                origin: userPos,
                destination: { placeId: place.place_id },
                travelMode: google.maps.TravelMode.DRIVING,
            }, (response, status) => {
                if (status === "OK") {
                    directionsRend.setDirections(response);
                    directionsRend.setPanel(document.getElementById('dir_box'));
                } else {
                    window.alert("Could not find route");
                }
            });
        });
    }
</script>

<style>
    /* Always set the map height explicitly to define the size of the div
 * element that contains the map. */
    #map {
        height: 100%;
    }

    /* Optional: Makes the sample page fill the window. */
    html,
    body {
        height: 100%;
        margin: 0;
        padding: 0;
    }
    .custom-map-control-button { 
        appearance: button;
        background-color: #fff;
        border: 0; 
        border-radius: 2px; 
        box-shadow: 0 1px 4px -1px rgba(0, 0, 0, 0.3);
        cursor: pointer; 
        margin: 10px; 
        padding: 0 0.5em; 
        height: 40px;
        font: 400 18px Roboto, Arial, sans-serif; 
        overflow: hidden; 
    } 
    .custom-map-control-button:hover { background: #559395; }
</style>

{% endblock %}
